<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BSH's Travel</title>
  <link rel="icon" href="../image/favicon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="../css/travel_map.css">
</head>
<body>

  <div class="sidebar" id="sidebar">
    <a href="/bsh_travel/main" title="메인으로 이동">
      <img src="../image/travel_logo.png" alt="BSH Travel Logo" class="logo" />
    </a>
    <div class="country-list" id="countryList"></div>
    <button id="toggleBtn" title="사이드바 닫기">🡄</button>
    <div class="description" id="description"></div>
    <button id="showCountryListBtn" class="title-btn hidden">← 나라 목록 보기</button>
  </div>
  <button id="openBtn" title="사이드바 열기">☰</button>

  <div class="mobile-controls" id="mobileControls">
    <div class="country-slider-container">
      <div id="country-slider" class="country-slider"></div>
    </div>
    <div id="info-panel" class="info-panel">
      <button id="back-button" class="back-button hidden">← 뒤로가기</button>
      <div id="content-list"></div>
    </div>
  </div>
  <button id="mobileToggleBtn">☰</button>
  <a href="/bsh_travel/main" id="mobileHomeBtn" title="메인으로 이동">🏠</a>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    // 주요 DOM 요소
    const sidebar = document.getElementById("sidebar");
    const description = document.getElementById("description");
    const mapDiv = document.getElementById("map");
    const toggleBtn = document.getElementById("toggleBtn");
    const openBtn = document.getElementById("openBtn");
    const countryListDiv = document.getElementById("countryList");
    const showCountryListBtn = document.getElementById("showCountryListBtn");

    const mobileControls = document.getElementById("mobileControls");
    const countrySlider = document.getElementById("country-slider");
    const infoPanel = document.getElementById("info-panel");
    const contentList = document.getElementById("content-list");
    const backButton = document.getElementById("back-button");
    const mobileToggleBtn = document.getElementById("mobileToggleBtn");
    

    let map, allCityMarkers = [], currentDetailMarkers = [], selectedCityMarker = null, selectedDetailMarker = null, selectedDetailListItem = null;
    let currentView = 'countries'; // 'countries', 'cities', 'details'
    let currentCountry = null;
    let currentCity = null;

    // 공통 데이터 (생략)
    const data = [
    {
        name: "일본",
        cities: [
            {
                name: "🍣 후쿠오카",
                lat: 33.586309,
                lng: 130.376301,
                desc: "가볍게 떠나기 좋은 가까운 여행지",
                sights: [
                	{
                        name: "오호리 공원",
                        lat: 33.586309,
                        lng: 130.376301,
                        imageUrl: "../image/image_japan05/place6-1.jpg"
                    },
                    {
                        name: "츠야타 서점 롯폰마츠",
                        lat: 33.577405,
                        lng: 130.377996,
                        imageUrl: "../image/image_japan05/place7-1.jpg"
                    }
                ],
                foods: [
                    {
                        name: "一蘭 本社総本店 - 이치란 라멘 본점",
                        lat: 33.593222,
                        lng: 130.404563,
                        imageUrl: "../image/image_japan05/food3-3.jpg"
                    },
                    {
                        name: "博多もつ鍋 朋樂 - 모츠나베",
                        lat: 33.588822,
                        lng: 130.421579,
                        imageUrl: "../image/image_japan05/food5-6.jpg"
                    }
                ]
            },
            {
                name: "🍣 시모노세키",
                lat: 33.9565664,
                lng: 130.9456336,
                desc: "가볍게 떠나기 좋은 가까운 여행지",
                sights: [
                    {
                        name: "가라토시장",
                        lat: 33.9565664,
                        lng: 130.9456336,
                        imageUrl: "../image/image_japan/place1-4.jpg"
                    },
                    {
                        name: "모지코",
                        lat: 33.9463622,
                        lng: 130.9586796,
                        imageUrl: "../image/image_japan/place2-4.jpg"
                    },
                    {
                        name: "아카미신궁",
                        lat: 33.959165,
                        lng: 130.948917,
                        imageUrl: "../image/image_japan/place3-1.jpg"
                    },
                    {
                        name: "영국영사관",
                        lat: 33.9569074,
                        lng: 130.9430147,
                        imageUrl: "../image/image_japan05/place1-1.jpg"
                    },
                    {
                        name: "카랏토요코쵸",
                        lat: 33.953191,
                        lng: 130.941130,
                        imageUrl: "../image/image_japan05/place4-1.jpg"
                    }
                ],
                foods: [
                    {
                        
                    }
                ]
            },
            {
                name: "🍣 유후인",
                lat: 33.266662,
                lng: 131.368931,
                desc: "가볍게 떠나기 좋은 가까운 여행지",
                sights: [
                    {
                        name: "킨린 호수",
                        lat: 33.266662,
                        lng: 131.368931,
                        imageUrl: "../image/image_japan/place3-1.jpg"
                    }
                ],
                foods: [
                    {
                        name: "ゆるりん - 연어까스",
                        lat: 33.2627319,
                        lng: 131.3553187,
                        imageUrl: "../image/image_japan/food3-1.jpg"
                    },
                    {
                        name: "B.Bee's - 벌꿀 아이스크림",
                        lat: 33.266318,
                        lng: 131.3621605,
                        imageUrl: "../image/image_japan/food4-3.jpg"
                    },
                    {
                        name: "湯布院金賞コロッケ - 고로켓",
                        lat: 33.266494,
                        lng: 131.362538,
                        imageUrl: "../image/image_japan/food5-1.jpg"
                    }
                ]
            },
            {
                name: "🍣 이토시마",
                lat: 33.639210,
                lng: 130.197161,
                desc: "가볍게 떠나기 좋은 가까운 여행지",
                sights: [
                    {
                        name: "사쿠라이 후타미가우라",
                        lat: 33.639210,
                        lng: 130.197161,
                        imageUrl: "../image/image_japan05/place8-1.jpg"
                    }
                ],
                foods: [
                    {
                        name: "糸島茶房 - 핫케이크",
                        lat: 33.640486,
                        lng: 130.200039,
                        imageUrl: "../image/image_japan05/food4-4.jpg"
                    }
                ]
            }
        ]
    }
];


    // 마커 아이콘 정의 (생략)
    const redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', shadowSize: [41, 41]
    });
    const sightIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', shadowSize: [41, 41]
    });
    const foodIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', shadowSize: [41, 41]
    });
    const cityMarkerIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', shadowSize: [41, 41]
    });

    // 맵 초기화
    function initMap() {
    if (map) map.remove();
    const bounds = [
        [-90, -180],
        [90, 180]
    ];
    map = L.map('map', {
        maxBounds: bounds,
        maxBoundsViscosity: 0.8,
        minZoom: 3,
        maxZoom: 19,
        zoomControl: false // 이 부분을 추가하여 확대/축소 버튼을 제거합니다.
    }).setView([30, 120], 2);
    
    // 이전에 있던 L.control.zoom() 코드는 삭제하거나 주석 처리합니다.
    // L.control.zoom({ position: 'topright' }).addTo(map); 

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = `<p><b>마커 정보</b></p><p><i style="background:#337ab7;"></i> 도시</p><p><i style="background:#5cb85c;"></i> 관광지</p><p><i style="background:#f0ad4e;"></i> 맛집</p>`;
        return div;
    };
    legend.addTo(map);
}
    
    function resetMapAndUI() {
        allCityMarkers.forEach(marker => map.removeLayer(marker));
        allCityMarkers = [];
        currentDetailMarkers.forEach(marker => map.removeLayer(marker));
        currentDetailMarkers = [];
        selectedCityMarker = null;
        selectedDetailMarker = null;
        selectedDetailListItem = null;
        createAllCityMarkers();
    }
    
    function createAllCityMarkers() {
        data.forEach(country => {
            country.cities.forEach(city => {
                const marker = L.marker([city.lat, city.lng], { icon: cityMarkerIcon }).addTo(map);
                marker.bindPopup(city.name);
                marker.on('click', () => {
                    if (window.innerWidth <= 768) {
                        currentCity = city;
                        showDetails(city);
                        mobileControls.classList.add('open');
                    } else {
                        showCityInfo(city);
                    }
                    map.setView([city.lat, city.lng], 10);
                });
                allCityMarkers.push(marker);
            });
        });
    }

    // 데스크톱 UI 로직
    function setupDesktopUI() {
        mobileControls.style.display = 'none';
        mobileToggleBtn.style.display = 'none';
        sidebar.style.display = 'flex';
        openSidebar();
        createCountryList();
        resetMapAndUI();
    }
    function createCountryList() {
        countryListDiv.innerHTML = "";
        data.forEach(country => {
            const countryBtn = document.createElement("button");
            countryBtn.className = "country-btn title-btn";
            countryBtn.textContent = country.name;
            countryListDiv.appendChild(countryBtn);
            const cityList = document.createElement("div");
            cityList.className = "city-list";
            country.cities.forEach(city => {
                const cityBtn = document.createElement("button");
                cityBtn.className = "city-btn";
                cityBtn.textContent = city.name;
                cityList.appendChild(cityBtn);
                cityBtn.addEventListener("click", () => {
                    showCityInfo(city);
                    
                    // panTo 대신 flyTo를 사용하고, zoom 레벨을 10으로 지정합니다.
                    const panOffset = [sidebar.offsetWidth / 2, 0];
                    map.flyTo([city.lat, city.lng], 10, {
                        padding: panOffset,
                    });
                });
            });
            countryListDiv.appendChild(cityList);
            countryBtn.addEventListener("click", () => {
                const isOpen = cityList.style.maxHeight !== "0px" && cityList.style.maxHeight !== "";
                document.querySelectorAll(".city-list").forEach(cl => cl.style.maxHeight = "0");
                if (!isOpen) { cityList.style.maxHeight = cityList.scrollHeight + "px"; }
                description.innerHTML = "";
                countryListDiv.classList.remove("hidden");
                showCountryListBtn.classList.add("hidden");
                resetMapAndUI();
            });
        });
    }
    function showCityInfo(city) {
        currentDetailMarkers.forEach(marker => map.removeLayer(marker));
        currentDetailMarkers = [];
        selectedDetailMarker = null;
        selectedDetailListItem = null;
        const cityMarker = allCityMarkers.find(marker => {
            const latLng = marker.getLatLng();
            return latLng.lat === city.lat && latLng.lng === city.lng;
        });
        if (selectedCityMarker) { selectedCityMarker.setIcon(cityMarkerIcon); }
        if (cityMarker) {
            cityMarker.setIcon(redIcon);
            selectedCityMarker = cityMarker;
        }
        description.innerHTML = "";
        description.classList.remove("hidden");
        countryListDiv.classList.add("hidden");
        showCountryListBtn.classList.remove("hidden");
        const cityTitle = document.createElement("h2");
        cityTitle.textContent = city.name;
        description.appendChild(cityTitle);
        const cityDesc = document.createElement("p");
        cityDesc.textContent = city.desc;
        description.appendChild(cityDesc);
        const sightsTitle = document.createElement("h3");
        sightsTitle.textContent = "🗼 관광지";
        description.appendChild(sightsTitle);
        const sightsList = document.createElement("ul");
        sightsList.id = "sights-list";
        description.appendChild(sightsList);
        city.sights.forEach(item => {
            const listItem = document.createElement("li");
            listItem.textContent = item.name;
            sightsList.appendChild(listItem);
            const marker = L.marker([item.lat, item.lng], { icon: sightIcon }).addTo(map);
            const popupContent = `<div style="text-align: center;"><h4>${item.name}</h4><img src="${item.imageUrl}" alt="${item.name}" style="width:150px; height:auto; border-radius: 5px;"></div>`;
            marker.bindPopup(popupContent);
            marker.originalIcon = sightIcon;
            currentDetailMarkers.push(marker);
            const onClick = () => {
                if (selectedDetailMarker) { selectedDetailMarker.setIcon(selectedDetailMarker.originalIcon); }
                if (selectedDetailListItem) { selectedDetailListItem.classList.remove("active"); }
                marker.setIcon(redIcon);
                marker.openPopup();
                listItem.classList.add("active");
                selectedDetailMarker = marker;
                selectedDetailListItem = listItem;
                
                const panOffset = [sidebar.offsetWidth / 2, 0];
                map.flyTo([item.lat, item.lng], 15, {
                    padding: panOffset,
                });
            };
            listItem.addEventListener("click", onClick);
            marker.on("click", onClick);
        });
        const foodsTitle = document.createElement("h3");
        foodsTitle.textContent = "🍽️ 맛집";
        description.appendChild(foodsTitle);
        const foodsList = document.createElement("ul");
        foodsList.id = "foods-list";
        description.appendChild(foodsList);
        city.foods.forEach(item => {
            const listItem = document.createElement("li");
            listItem.textContent = item.name;
            foodsList.appendChild(listItem);
            const marker = L.marker([item.lat, item.lng], { icon: foodIcon }).addTo(map);
            const popupContent = `<div style="text-align: center;"><h4>${item.name}</h4><img src="${item.imageUrl}" alt="${item.name}" style="width:150px; height:auto; border-radius: 5px;"></div>`;
            marker.bindPopup(popupContent);
            marker.originalIcon = foodIcon;
            currentDetailMarkers.push(marker);
            const onClick = () => {
                if (selectedDetailMarker) { selectedDetailMarker.setIcon(selectedDetailMarker.originalIcon); }
                if (selectedDetailListItem) { selectedDetailListItem.classList.remove("active"); }
                marker.setIcon(redIcon);
                marker.openPopup();
                listItem.classList.add("active");
                selectedDetailMarker = marker;
                selectedDetailListItem = listItem;
                
                const panOffset = [sidebar.offsetWidth / 2, 0];
                map.flyTo([item.lat, item.lng], 15, {
                    padding: panOffset,
                });
            };
            listItem.addEventListener("click", onClick);
            marker.on("click", onClick);
        });
    }

    // 모바일 UI 로직
    function setupMobileUI() {
        sidebar.style.display = 'none';
        mobileControls.style.display = 'flex';
        mobileControls.classList.add('closed');
        mobileToggleBtn.style.display = 'flex';
        createCountrySlider();
        resetMapAndUI();
    }
    
    function toggleMobileControls() {
        const isOpen = mobileControls.classList.contains('open');
        if (isOpen) {
            mobileControls.classList.remove('open');
            mobileControls.classList.add('closed');
            mobileToggleBtn.textContent = '☰';
        } else {
            mobileControls.classList.remove('closed');
            mobileControls.classList.add('open');
            mobileToggleBtn.textContent = '✖';
        }
    }
    
    function createCountrySlider() {
        currentView = 'countries';
        infoPanel.style.display = 'none';
        backButton.classList.add('hidden');
        countrySlider.innerHTML = "";
        countrySlider.style.display = 'flex';
        
        data.forEach(country => {
            const countryBtn = document.createElement("button");
            countryBtn.className = "country-btn";
            countryBtn.textContent = country.name;
            countrySlider.appendChild(countryBtn);
            countryBtn.addEventListener('click', () => {
                currentCountry = country;
                showCities(country);
            });
        });
    }
    function showCities(country) {
        currentView = 'cities';
        countrySlider.style.display = 'none';
        infoPanel.style.display = 'block';
        backButton.classList.remove('hidden');
        contentList.innerHTML = `<h4 class="title">${country.name}</h4>`;
        
        country.cities.forEach(city => {
            const listItem = document.createElement("li");
            listItem.textContent = city.name;
            contentList.appendChild(listItem);
            listItem.addEventListener('click', () => {
                currentCity = city;
                showDetails(city);
                map.setView([city.lat, city.lng], 10);
            });
        });
        
        currentDetailMarkers.forEach(marker => map.removeLayer(marker));
        currentDetailMarkers = [];

        allCityMarkers.forEach(marker => map.removeLayer(marker));
        allCityMarkers = [];
        country.cities.forEach(city => {
            const marker = L.marker([city.lat, city.lng], { icon: cityMarkerIcon }).addTo(map);
            marker.on('click', () => {
                currentCity = city;
                showDetails(city);
                map.setView([city.lat, city.lng], 10);
            });
            allCityMarkers.push(marker);
        });
    }
 // `showDetails` 함수 수정
    function showDetails(city) {
        currentView = 'details';
        backButton.classList.remove('hidden');
        contentList.innerHTML = `<h4 class="title">${city.name}</h4><p>${city.desc}</p>`;
        
        // 모바일 UI에서는 도시 마커를 지우는 대신, 기존 마커를 재활용하여 아이콘을 변경합니다.
        allCityMarkers.forEach(marker => map.removeLayer(marker));
        allCityMarkers = [];
        
        const allItems = [...city.sights.map(item => ({ ...item, type: 'sight' })), ...city.foods.map(item => ({ ...item, type: 'food' }))];
        
        currentDetailMarkers.forEach(marker => map.removeLayer(marker));
        currentDetailMarkers = [];
        
        // 도시 마커 아이콘 변경 로직은 제거하고, 세부 정보 마커만 표시
        
        allItems.forEach(item => {
            const listItem = document.createElement("li");
            listItem.innerHTML = `<img src="${item.imageUrl || './image/placeholder.png'}" alt="${item.name}" /><span>${item.name}</span>`;
            contentList.appendChild(listItem);
            
            const icon = item.type === 'sight' ? sightIcon : foodIcon;
            const marker = L.marker([item.lat, item.lng], { icon: icon }).addTo(map);

            // 마커에 이미지와 정보를 담은 팝업을 바인딩합니다.
            const popupContent = `
                <div style="text-align: center;">
                    <h4>${item.name}</h4>
                    <img src="${item.imageUrl}" alt="${item.name}" style="width: 150px; height: auto; border-radius: 5px;">
                </div>
            `;
            marker.bindPopup(popupContent);
            
            marker.originalIcon = icon;
            currentDetailMarkers.push(marker);
            
            const onClick = () => {
                if (selectedDetailMarker) { selectedDetailMarker.setIcon(selectedDetailMarker.originalIcon); }
                if (selectedDetailListItem) { selectedDetailListItem.classList.remove("active"); }
                
                marker.setIcon(redIcon);
                marker.openPopup();
                listItem.classList.add("active");
                
                selectedDetailMarker = marker;
                selectedDetailListItem = listItem;
                
                map.setView([item.lat, item.lng], 15);
            };
            
            listItem.addEventListener("click", onClick);
            marker.on("click", onClick);
        });
    }

    // 데스크톱 사이드바 토글 함수
    function closeSidebar() {
	    sidebar.classList.add("closed");
	    mapDiv.classList.add("expanded");
	    openBtn.style.display = 'block';
	    toggleBtn.style.display = 'none';
	}
	function openSidebar() {
	    sidebar.classList.remove("closed");
	    mapDiv.classList.remove("expanded");
	    openBtn.style.display = 'none';
	    toggleBtn.style.display = 'block';
	}
    
    // 화면 크기 변경 감지 및 UI 초기화
    function handleResize() {
        if (window.innerWidth <= 768) {
            setupMobileUI();
        } else {
            setupDesktopUI();
        }
    }

    // 이벤트 리스너
    toggleBtn.addEventListener("click", closeSidebar);
    openBtn.addEventListener("click", openSidebar);
    showCountryListBtn.addEventListener("click", () => {
        description.classList.add("hidden");
        countryListDiv.classList.remove("hidden");
        showCountryListBtn.classList.add("hidden");
        resetMapAndUI();
        if (selectedCityMarker) {
            selectedCityMarker.setIcon(cityMarkerIcon);
            selectedCityMarker = null;
        }
    });
    backButton.addEventListener("click", () => {
        if (currentView === 'cities') {
            createCountrySlider();
        } else if (currentView === 'details') {
            showCities(currentCountry);
        }
    });
    
    mobileToggleBtn.addEventListener("click", toggleMobileControls);

    // 초기 실행
    initMap();
    handleResize();
    window.addEventListener('resize', handleResize);
</script>
</body>
</html>
